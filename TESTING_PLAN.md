# –ü–ª–∞–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è User Context –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-05
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (commit 8f382c5)

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–ø–æ—Ä—Ç–∞ calculate_age
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö (`crud.py` –∏ `start.py`)
**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ `start.py`, –¥–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –∏–∑ `crud.py`
**–§–∞–π–ª—ã:** [bot/handlers/start.py:7](bot/handlers/start.py#L7)

### ‚úÖ 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ None –∑–Ω–∞—á–µ–Ω–∏–π –≤ user_context
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ `age=None` –≤ –ø—Ä–æ–º–ø—Ç–µ –ø–æ—è–≤–ª—è–ª–æ—Å—å "None –ª–µ—Ç"
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
**–§–∞–π–ª—ã:** [bot/services/prompt_builder.py:286-288](bot/services/prompt_builder.py#L286)

### ‚úÖ 3. Callback data –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
**–°—Ç–∞—Ç—É—Å:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥: `work_format_remote`, `work_format_office`, etc.
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `work_remote_edit`, `work_office_edit`, etc.

### ‚úÖ 4. –í–∞–ª–∏–¥–∞—Ü–∏—è 50 —Å–ª–æ–≤ –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ú–µ—Ç–æ–¥ `.split()` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- [bot/handlers/problem_flow.py:67](bot/handlers/problem_flow.py#L67)

### ‚úÖ 5. FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–°—Ç–∞—Ç—É—Å:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ StatesGroup
- `OnboardingStates` vs `ProfileEditStates` vs `ProblemSolvingStates`

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–ª–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∞ user context –∏ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã.

**–®–∞–≥–∏:**
1. `/start` ‚Üí –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
2. –í—ã–±—Ä–∞—Ç—å –ø–æ–ª (–ú/–ñ)
3. –í–≤–µ—Å—Ç–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
4. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç")
5. –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã (–£–¥–∞–ª–µ–Ω–Ω–æ/–û—Ñ–∏—Å/–ì–∏–±—Ä–∏–¥/–°—Ç—É–¥–µ–Ω—Ç)
6. –ù–∞–∂–∞—Ç—å "üöÄ –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É"
7. –û–ø–∏—Å–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É (–º–∏–Ω–∏–º—É–º 50 —Å–ª–æ–≤)
8. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ 3-5 –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç Claude
9. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- –í –ø—Ä–æ–º–ø—Ç–µ Claude –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è "# –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø" —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
  - –ü–æ–ª: –ú—É–∂—Å–∫–æ–π/–ñ–µ–Ω—Å–∫–∏–π
  - –í–æ–∑—Ä–∞—Å—Ç: 30 –ª–µ—Ç (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –∏–∑ birth_date)
  - –ó–∞–Ω—è—Ç–æ—Å—Ç—å: –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç
  - –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã: –†–∞–±–æ—Ç–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω–æ –∏–∑ –¥–æ–º–∞
- Claude —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ —Ä–µ—à–µ–Ω–∏–∏
- –ù–µ—Ç "None" –≤ –ø—Ä–æ–º–ø—Ç–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```bash
sqlite3 bot_database.db "SELECT telegram_id, gender, birth_date, occupation, work_format FROM users WHERE telegram_id=YOUR_ID;"
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø—Ä–æ–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ user context.

**–®–∞–≥–∏:**
1. `/start` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
2. –ù–∞–∂–∞—Ç—å "–ó–∞–ø–æ–ª–Ω—é –ø–æ–∑–∂–µ" (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞) –ò–õ–ò —Å—Ä–∞–∑—É "üöÄ –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É"
3. –û–ø–∏—Å–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É (50+ —Å–ª–æ–≤)
4. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
5. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í –ë–î: `gender=NULL`, `birth_date=NULL`, `occupation=NULL`, `work_format=NULL`
- –í –ø—Ä–æ–º–ø—Ç–µ Claude —Å–µ–∫—Ü–∏—è "# –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø" –ù–ï –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–∏–ª–∏ –≤—Å–µ –ø–æ–ª—è "–Ω–µ —É–∫–∞–∑–∞–Ω")
- –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, Claude –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
sqlite3 bot_database.db "SELECT gender, birth_date, occupation, work_format FROM users WHERE telegram_id=YOUR_ID;"
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.

**–®–∞–≥–∏:**
1. –ü–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –Ω–∞–∂–∞—Ç—å "üë§ –ü—Ä–æ—Ñ–∏–ª—å" (–∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/profile`)
2. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª" ‚Üí –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ–ª
3. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è" ‚Üí –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—É—é –¥–∞—Ç—É
4. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é" ‚Üí –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é
5. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã" ‚Üí –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
6. –†–µ—à–∏—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î
- –ü—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –í–æ–∑—Ä–∞—Å—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ –Ω–æ–≤–æ–π birth_date

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
sqlite3 bot_database.db "SELECT gender, birth_date, occupation, work_format FROM users WHERE telegram_id=YOUR_ID;"
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (—Ç–æ–ª—å–∫–æ –ø–æ–ª –∏ –≤–æ–∑—Ä–∞—Å—Ç)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.

**–®–∞–≥–∏:**
1. –ü—Ä–æ–π—Ç–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥, –Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ:
   - –ü–æ–ª: –ú—É–∂—Å–∫–æ–π
   - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: 15.03.1990
   - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π)
   - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã
2. –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í –ø—Ä–æ–º–ø—Ç–µ:
  - –ü–æ–ª: –ú—É–∂—Å–∫–æ–π
  - –í–æ–∑—Ä–∞—Å—Ç: 35 –ª–µ—Ç (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
  - –ó–∞–Ω—è—Ç–æ—Å—Ç—å: –Ω–µ —É–∫–∞–∑–∞–Ω–∞
  - –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã: –ù–µ —É–∫–∞–∑–∞–Ω
- –ù–µ—Ç "None" –≤ –ø—Ä–æ–º–ø—Ç–µ
- Claude —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è.

**–®–∞–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. –û–Ω–±–æ—Ä–¥–∏–Ω–≥ ‚Üí –≤–≤–æ–¥ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
   - `1990-03-15` (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
   - `32.13.1990` (–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –¥–∞—Ç–∞)
   - `15/03/1990` (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
   - `abc` (–Ω–µ –¥–∞—Ç–∞)
   - `01.01.2030` (–±—É–¥—É—â–µ–µ)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–æ—Ç –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º:
  "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚ö†Ô∏è\n\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì\n–ù–∞–ø—Ä–∏–º–µ—Ä: 15.03.1995"
- –ü–æ—Å–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (`15.03.1990`) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

**–§–∞–π–ª:** [bot/handlers/start.py:25-43](bot/handlers/start.py#L25)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `calculate_age()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç.

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏:**

| –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è | –°–µ–≥–æ–¥–Ω—è      | –û–∂–∏–¥–∞–µ–º—ã–π –≤–æ–∑—Ä–∞—Å—Ç | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ                          |
|---------------|--------------|-------------------|-------------------------------------|
| 15.03.1990    | 05.10.2025   | 35                | –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É–∂–µ –ø—Ä–æ—à–µ–ª            |
| 15.11.1990    | 05.10.2025   | 34                | –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª       |
| 05.10.2000    | 05.10.2025   | 25                | –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è               |
| 29.02.2000    | 28.02.2025   | 24                | –í–∏—Å–æ–∫–æ—Å–Ω—ã–π –≥–æ–¥, –î–† –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª      |
| 29.02.2000    | 01.03.2025   | 25                | –í–∏—Å–æ–∫–æ—Å–Ω—ã–π –≥–æ–¥, –î–† –ø—Ä–æ—à–µ–ª           |

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```python
from bot.database.crud import calculate_age
from datetime import datetime

# –¢–µ—Å—Ç 1: –î–† —É–∂–µ –ø—Ä–æ—à–µ–ª
assert calculate_age(datetime(1990, 3, 15)) == 35

# –¢–µ—Å—Ç 2: –î–† –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª (–µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è < 15 –Ω–æ—è–±—Ä—è)
# assert calculate_age(datetime(1990, 11, 15)) == 34

# –¢–µ—Å—Ç 3: None handling
assert calculate_age(None) is None
```

**–§–∞–π–ª:** [bot/database/crud.py:9-16](bot/database/crud.py#L9)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å user context

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ user context –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ system prompt –¥–ª—è Claude.

**–®–∞–≥–∏:**
1. –ó–∞–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º:
   - –ü–æ–ª: –ñ–µ–Ω—Å–∫–∏–π
   - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: 20.05.1995 (–≤–æ–∑—Ä–∞—Å—Ç ‚âà 30 –ª–µ—Ç)
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: "UX-–¥–∏–∑–∞–π–Ω–µ—Ä"
   - –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã: –ì–∏–±—Ä–∏–¥
2. –ù–∞—á–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
3. –ü–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å system prompt (–¥–æ–±–∞–≤–∏—Ç—å `logger.info(system_prompt)` –≤ `claude_service.py`)

**–û–∂–∏–¥–∞–µ–º—ã–π –≤–∏–¥ –ø—Ä–æ–º–ø—Ç–∞:**
```
# –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

–ü–æ–ª: –ñ–µ–Ω—Å–∫–∏–π
–í–æ–∑—Ä–∞—Å—Ç: 30 –ª–µ—Ç
–ó–∞–Ω—è—Ç–æ—Å—Ç—å: UX-–¥–∏–∑–∞–π–Ω–µ—Ä
–§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã: –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–¥–æ–º + –æ—Ñ–∏—Å)

**–£—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é ‚Üí —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –∫—Ä–∏—Ç–∏—á–µ–Ω
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö ‚Üí –æ—Ñ–∏—Å = –∫–æ–ª–ª–µ–≥–∏, –¥–æ–º = —Å–µ–º—å—è
- –ü—Ä–∏ –≤—ã–≥–æ—Ä–∞–Ω–∏–∏ ‚Üí —É–¥–∞–ª–µ–Ω–∫–∞ –∏ –æ—Ñ–∏—Å = —Ä–∞–∑–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
- –í–æ–∑—Ä–∞—Å—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ —Ä–µ—à–µ–Ω–∏—è

# –ì–ï–ù–î–ï–†–ù–û-–ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ö–û–ú–ú–£–ù–ò–ö–ê–¶–ò–Ø (–ñ–ï–ù–©–ò–ù–ê)
...
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í –ª–æ–≥–∞—Ö (`bot.log`) –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É —Å system_prompt
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:
  - –í–æ–∑—Ä–∞—Å—Ç = —á–∏—Å–ª–æ (–Ω–µ "None –ª–µ—Ç")
  - –í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  - –ï—Å—Ç—å –≥–µ–Ω–¥–µ—Ä–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è –∂–µ–Ω—â–∏–Ω

**–§–∞–π–ª:** [bot/services/prompt_builder.py:264-310](bot/services/prompt_builder.py#L264)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 8: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å Claude –ø–æ–¥ user context

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Claude –∏—Å–ø–æ–ª—å–∑—É–µ—Ç user context –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ —Ä–µ—à–µ–Ω–∏–∏.

**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã:**

#### 8.1 –£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ + –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
- **–ü—Ä–æ—Ñ–∏–ª—å:** –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, 28 –ª–µ—Ç, —É–¥–∞–ª–µ–Ω–∫–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** "–ù–µ –º–æ–≥—É —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–æ–º–∞, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ—Ç–≤–ª–µ–∫–∞—é—Å—å –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏ –∏ –¥–æ–º–∞—à–Ω–∏–µ –¥–µ–ª–∞. –†–∞–±–æ—Ç–∞—é –∏–∑ –¥–æ–º–∞ —É–∂–µ –≥–æ–¥, –Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞. –ü—Ä–æ–±–æ–≤–∞–ª —Ç–∞–π–º–µ—Ä—ã –∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Å–∞–π—Ç–æ–≤ ‚Äî –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç."

**–û–∂–∏–¥–∞–Ω–∏—è:**
- Claude —Å–ø—Ä–æ—Å–∏—Ç –ø—Ä–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –¥–æ–º–∞
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç —Ä–µ—à–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —É–¥–∞–ª–µ–Ω–∫–∏ (–Ω–µ "–ø–æ–π–¥–∏ –≤ –æ—Ñ–∏—Å")

#### 8.2 –û—Ñ–∏—Å + –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–ª–ª–µ–≥–∞–º–∏
- **–ü—Ä–æ—Ñ–∏–ª—å:** –ú–µ–Ω–µ–¥–∂–µ—Ä, 35 –ª–µ—Ç, –æ—Ñ–∏—Å
- **–ü—Ä–æ–±–ª–µ–º–∞:** "–ö–æ–ª–ª–µ–≥–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ—Ç–≤–ª–µ–∫–∞—é—Ç –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å–∞–º–∏, –Ω–µ –º–æ–≥—É —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á–∞—Ö. –í –æ—Ñ–∏—Å–µ —à—É–º–Ω–æ, –∞ —Ä–∞–±–æ—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ–±–æ–≤–∞–ª –Ω–∞—É—à–Ω–∏–∫–∏ ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞."

**–û–∂–∏–¥–∞–Ω–∏—è:**
- Claude —É—á—Ç–µ—Ç –æ—Ñ–∏—Å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –ù–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç "—Ä–∞–±–æ—Ç–∞–π –∏–∑ –¥–æ–º–∞" –∫–∞–∫ —Ä–µ—à–µ–Ω–∏–µ

#### 8.3 –ú–æ–ª–æ–¥–æ–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç vs –æ–ø—ã—Ç–Ω—ã–π
- **–ü—Ä–æ—Ñ–∏–ª—å 1:** 23 –≥–æ–¥–∞, —Å—Ç—É–¥–µ–Ω—Ç
- **–ü—Ä–æ—Ñ–∏–ª—å 2:** 45 –ª–µ—Ç, —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä
- **–û–¥–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:** "–ù–µ –∑–Ω–∞—é, –º–µ–Ω—è—Ç—å –ª–∏ —Ä–∞–±–æ—Ç—É"

**–û–∂–∏–¥–∞–Ω–∏—è:**
- –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞: —Ñ–æ–∫—É—Å –Ω–∞ –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö, –æ–±—É—á–µ–Ω–∏–∏
- –î–ª—è —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä–∞: —Ñ–æ–∫—É—Å –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, —Ñ–∏–Ω–∞–Ω—Å–∞—Ö, legacy

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 9: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç.

**–®–∞–≥–∏:**
1. –ù–∞—á–∞—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ `OnboardingStates.entering_birth_date`)
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–≤ –¥—Ä—É–≥–æ–π —Å–µ—Å—Å–∏–∏/–∫–æ–º–∞–Ω–¥–µ) –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
3. –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
4. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- FSM –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- –ù–µ—Ç "–∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏—è" –≤ –æ–¥–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

**–§–∞–π–ª—ã:**
- [bot/states.py](bot/states.py)
- [bot/handlers/start.py](bot/handlers/start.py) (–æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
- [bot/handlers/profile.py](bot/handlers/profile.py) (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 10: –í–∞–ª–∏–¥–∞—Ü–∏—è 50 —Å–ª–æ–≤ (—Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—á–∏—Ç–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞.

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏:**

| –¢–µ–∫—Å—Ç                                                                                                                                                                                                                                                                       | –°–ª–æ–≤ | –†–µ–∑—É–ª—å—Ç–∞—Ç     |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------|---------------|
| "–ü—Ä–æ–±–ª–µ–º–∞." (1 —Å–ª–æ–≤–æ)                                                                                                                                                                                                                                                       | 1    | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ     |
| "–ù–µ –º–æ–≥—É –∑–∞—Å–Ω—É—Ç—å —É–∂–µ –Ω–µ–¥–µ–ª—é. –õ–æ–∂—É—Å—å –≤ –ø–æ–ª–Ω–æ—á—å, –∫—Ä—É—á—É—Å—å –¥–æ 3-4 —É—Ç—Ä–∞. –£—Ç—Ä–æ–º –≤—Å—Ç–∞—é —Ä–∞–∑–±–∏—Ç—ã–π. –ü—Ä–æ–±–æ–≤–∞–ª –º–µ–¥–∏—Ç–∞—Ü–∏—é ‚Äî –Ω–µ –ø–æ–º–æ–≥–ª–æ. –ö–æ—Ñ–µ –ø—å—é —Ç–æ–ª—å–∫–æ –¥–æ –æ–±–µ–¥–∞. –°–ø–æ—Ä—Ç 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é. –°—Ç—Ä–µ—Å—Å –Ω–∞ —Ä–∞–±–æ—Ç–µ –≤—ã—Å–æ–∫–∏–π. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –¥—É–º–∞—é –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö. –ú–µ–ª–∞—Ç–æ–Ω–∏–Ω –ø–∏–ª ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª 2 –¥–Ω—è." | 49   | –û—Ç–∫–ª–æ–Ω–µ–Ω–æ     |
| "–ù–µ –º–æ–≥—É –∑–∞—Å–Ω—É—Ç—å —É–∂–µ –Ω–µ–¥–µ–ª—é. –õ–æ–∂—É—Å—å –≤ –ø–æ–ª–Ω–æ—á—å, –∫—Ä—É—á—É—Å—å –¥–æ 3-4 —É—Ç—Ä–∞. –£—Ç—Ä–æ–º –≤—Å—Ç–∞—é —Ä–∞–∑–±–∏—Ç—ã–π. –ü—Ä–æ–±–æ–≤–∞–ª –º–µ–¥–∏—Ç–∞—Ü–∏—é ‚Äî –Ω–µ –ø–æ–º–æ–≥–ª–æ. –ö–æ—Ñ–µ –ø—å—é —Ç–æ–ª—å–∫–æ –¥–æ –æ–±–µ–¥–∞. –°–ø–æ—Ä—Ç 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é. –°—Ç—Ä–µ—Å—Å –Ω–∞ —Ä–∞–±–æ—Ç–µ –≤—ã—Å–æ–∫–∏–π. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –¥—É–º–∞—é –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö. –ú–µ–ª–∞—Ç–æ–Ω–∏–Ω –ø–∏–ª ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª 2 –¥–Ω—è. –ü–æ–º–æ–≥–∏." | 51   | ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ     |
| –¢–µ–∫—Å—Ç —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏                                                                                                                                                                                                                          | 50+  | ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ     |

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```python
text = "–ù–µ –º–æ–≥—É –∑–∞—Å–Ω—É—Ç—å —É–∂–µ –Ω–µ–¥–µ–ª—é..."
assert len(text.split()) >= 50
```

**–§–∞–π–ª:** [bot/handlers/problem_flow.py:67-79](bot/handlers/problem_flow.py#L67)

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ `bot.log` –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è:
- –§–∞–∫—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∂–¥–æ–µ –ø–æ–ª–µ)
- –†–∞—Å—á–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è system prompt —Å user context

### 2. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è user context, –∏–º–µ—é—Ç `gender=NULL`, `birth_date=NULL` –∏ —Ç.–¥.

**–¢–µ—Å—Ç:**
1. –ù–∞–π—Ç–∏ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å `NULL` –ø–æ–ª—è–º–∏ –≤—Ä—É—á–Ω—É—é)
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –ø–æ–¥ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
3. –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

**–û–∂–∏–¥–∞–Ω–∏—è:**
- –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–µ—Ç –æ—à–∏–±–æ–∫ "NoneType object..."
- –ü—Ä–æ–º–ø—Ç –±–µ–∑ —Å–µ–∫—Ü–∏–∏ "# –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø" –∏–ª–∏ —Å "–Ω–µ —É–∫–∞–∑–∞–Ω" –≤–æ –≤—Å–µ—Ö –ø–æ–ª—è—Ö

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å:
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
  "–¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã! –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å: /profile"

---

## üöÄ –ü–æ—Ä—è–¥–æ–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (30 –º–∏–Ω)
1. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1 (–ø–æ–ª–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
2. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3 (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è)
3. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5 (–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã)
4. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 10 (–≤–∞–ª–∏–¥–∞—Ü–∏—è 50 —Å–ª–æ–≤)

### –≠—Ç–∞–ø 2: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ (20 –º–∏–Ω)
5. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2 (–ø—Ä–æ–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞)
6. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4 (—á–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å)
7. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 6 (—Ä–∞—Å—á–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞)

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Claude (40 –º–∏–Ω)
8. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 7 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞)
9. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 8 (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å Claude)

### –≠—Ç–∞–ø 4: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã (10 –º–∏–Ω)
10. ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 9 (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ FSM)
11. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (—Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~1.5-2 —á–∞—Å–∞

---

## üìã –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

–†–µ–ª–∏–∑ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é, –µ—Å–ª–∏:
- ‚úÖ –í—Å–µ 10 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- ‚úÖ User context –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Claude
- ‚úÖ Claude –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ —Ä–µ—à–µ–Ω–∏—è—Ö
- ‚úÖ –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è) —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ù–µ—Ç "None" –∏–ª–∏ "undefined" –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö
- ‚úÖ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (commit 8f382c5)

1. **calculate_age –¥—É–±–ª–∏–∫–∞—Ç** ‚Üí –£–¥–∞–ª–µ–Ω –∏–∑ `start.py`, –∏–º–ø–æ—Ä—Ç –∏–∑ `crud.py`
2. **None –≤ user_context** ‚Üí –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ `prompt_builder.py:286-288`
3. **callback_data –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** ‚Üí –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
4. **FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è** ‚Üí –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ StatesGroup, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞

```
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–ª–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 3: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 5: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 6: –†–∞—Å—á–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å user context
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 8.1: –£–¥–∞–ª–µ–Ω–∫–∞ + –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 8.2: –û—Ñ–∏—Å + –∫–æ–ª–ª–µ–≥–∏
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 8.3: –ú–æ–ª–æ–¥–æ–π vs –æ–ø—ã—Ç–Ω—ã–π
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 9: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
[ ] –°—Ü–µ–Ω–∞—Ä–∏–π 10: –í–∞–ª–∏–¥–∞—Ü–∏—è 50 —Å–ª–æ–≤
[ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (bot.log)
[ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (—Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
[ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î (–≤—Å–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
```

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –û—á–∏—Å—Ç–∫–∞ –ë–î (–¥–ª—è —á–∏—Å—Ç—ã—Ö —Ç–µ—Å—Ç–æ–≤)
```bash
# –£–¥–∞–ª–∏—Ç—å –ë–î –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
rm bot_database.db
python << EOF
import asyncio
from bot.database.engine import init_db
asyncio.run(init_db())
EOF
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä user context –≤ –ë–î
```bash
sqlite3 bot_database.db "SELECT telegram_id, gender, birth_date, occupation, work_format FROM users;"
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
–í `bot/services/claude_service.py` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ –≤ Claude:
```python
logger.info(f"System prompt with user context:\n{system_prompt}")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
```python
from bot.database.crud import calculate_age
from datetime import datetime

birth_date = datetime(1990, 3, 15)
age = calculate_age(birth_date)
print(f"Age: {age}")  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 35 (–Ω–∞ 05.10.2025)
```

---

**–ê–≤—Ç–æ—Ä –ø–ª–∞–Ω–∞:** Claude Code
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-05
