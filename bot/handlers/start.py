from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder
from bot.database.engine import AsyncSessionLocal
from bot.database.crud import get_or_create_user

router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message):
    """Handle /start command"""
    # Get or create user in database
    async with AsyncSessionLocal() as session:
        user = await get_or_create_user(
            session=session,
            telegram_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name
        )

    # Create inline keyboard with main actions
    builder = InlineKeyboardBuilder()
    builder.button(text="üöÄ –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É", callback_data="new_problem")
    builder.button(text="üìñ –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π", callback_data="my_problems")
    builder.button(text="üí≥ –ö—É–ø–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è", callback_data="buy_solutions")
    builder.button(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="help")
    builder.adjust(1)  # 1 button per row

    # Welcome message
    welcome_text = f"""üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ª—é–±—É—é –ø—Ä–æ–±–ª–µ–º—É –∏ –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ.

üéØ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –û–ø–∏—à–∏ —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É
2. –Ø –∑–∞–¥–∞–º —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
3. –¢—ã –ø–æ–ª—É—á–∏—à—å –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–∏—á–∏–Ω—É –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

üìä **–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏:**
‚Ä¢ 5 –ü–æ—á–µ–º—É ‚Äî –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
‚Ä¢ Fishbone ‚Äî –¥–ª—è –º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
‚Ä¢ First Principles ‚Äî –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

üí≥ **–î–æ—Å—Ç—É–ø–Ω–æ —Ä–µ—à–µ–Ω–∏–π:** {user.problems_remaining}
üí¨ **–î–æ—Å—Ç—É–ø–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤:** {user.discussion_credits}

–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å?"""

    await message.answer(
        text=welcome_text,
        reply_markup=builder.as_markup()
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """Handle /help command"""
    help_text = """üìö **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:**

1Ô∏è‚É£ –ù–∞–∂–º–∏ "üöÄ –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É"
2Ô∏è‚É£ –û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö
3Ô∏è‚É£ –û—Ç–≤–µ—á–∞–π –Ω–∞ –º–æ–∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
4Ô∏è‚É£ –ü–æ–ª—É—á–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è

üîç **–¢–∏–ø—ã –ø—Ä–æ–±–ª–µ–º:**

**–õ–∏–Ω–µ–π–Ω–∞—è** ‚Äî –ø—Ä—è–º–∞—è –ø—Ä–∏—á–∏–Ω–∞-—Å–ª–µ–¥—Å—Ç–≤–∏–µ
–ü—Ä–∏–º–µ—Ä: "–ù–µ –º–æ–≥—É –≤—Å—Ç–∞—Ç—å —Ä–∞–Ω–æ —É—Ç—Ä–æ–º"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "5 –ü–æ—á–µ–º—É"

**–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è** ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏—á–∏–Ω
–ü—Ä–∏–º–µ—Ä: "–ü–∞–¥–∞—é—Ç –ø—Ä–æ–¥–∞–∂–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "Fishbone"

**–°–∏—Å—Ç–µ–º–Ω–∞—è** ‚Äî —Å–ª–æ–∂–Ω—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏
–ü—Ä–∏–º–µ—Ä: "–ö–∞–∫ –≤—ã–π—Ç–∏ –Ω–∞ –Ω–æ–≤—ã–π —Ä—ã–Ω–æ–∫"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "First Principles"

üí° **–°–æ–≤–µ—Ç—ã:**
‚Ä¢ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
‚Ä¢ –û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ù–µ —Å–ø–µ—à–∏ ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

‚ùì **–í–æ–ø—Ä–æ—Å—ã?** –ü–∏—à–∏ @your_username"""

    await message.answer(help_text)

@router.callback_query(F.data == "help")
async def callback_help(callback: CallbackQuery):
    """Handle help button press"""
    help_text = """üìö **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:**

1Ô∏è‚É£ –ù–∞–∂–º–∏ "üöÄ –†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É"
2Ô∏è‚É£ –û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö
3Ô∏è‚É£ –û—Ç–≤–µ—á–∞–π –Ω–∞ –º–æ–∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
4Ô∏è‚É£ –ü–æ–ª—É—á–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è

üîç **–¢–∏–ø—ã –ø—Ä–æ–±–ª–µ–º:**

**–õ–∏–Ω–µ–π–Ω–∞—è** ‚Äî –ø—Ä—è–º–∞—è –ø—Ä–∏—á–∏–Ω–∞-—Å–ª–µ–¥—Å—Ç–≤–∏–µ
–ü—Ä–∏–º–µ—Ä: "–ù–µ –º–æ–≥—É –≤—Å—Ç–∞—Ç—å —Ä–∞–Ω–æ —É—Ç—Ä–æ–º"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "5 –ü–æ—á–µ–º—É"

**–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è** ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏—á–∏–Ω
–ü—Ä–∏–º–µ—Ä: "–ü–∞–¥–∞—é—Ç –ø—Ä–æ–¥–∞–∂–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "Fishbone"

**–°–∏—Å—Ç–µ–º–Ω–∞—è** ‚Äî —Å–ª–æ–∂–Ω—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏
–ü—Ä–∏–º–µ—Ä: "–ö–∞–∫ –≤—ã–π—Ç–∏ –Ω–∞ –Ω–æ–≤—ã–π —Ä—ã–Ω–æ–∫"
‚Üí –ò—Å–ø–æ–ª—å–∑—É—é –º–µ—Ç–æ–¥–∏–∫—É "First Principles"

üí° **–°–æ–≤–µ—Ç—ã:**
‚Ä¢ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
‚Ä¢ –û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ù–µ —Å–ø–µ—à–∏ ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

‚ùì **–í–æ–ø—Ä–æ—Å—ã?** –ü–∏—à–∏ @your_username"""

    await callback.message.answer(help_text)
    await callback.answer()
